<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>노션 프로필 이미지 생성기</title>
  <style>
    /* 디자인 토큰 */
    :root {
      --background: oklch(0.9692 0.0192 343.9344);
      --foreground: oklch(0.4426 0.1653 352.3762);
      --card: oklch(0.9837 0.0107 339.3288);
      --card-foreground: oklch(0.4426 0.1653 352.3762);
      --primary: oklch(0.5227 0.2023 357.1371);
      --primary-foreground: oklch(1.0000 0 0);
      --secondary: oklch(0.9618 0.0339 325.8373);
      --secondary-foreground: oklch(0.4426 0.1653 352.3762);
      --border: oklch(0.8881 0.0747 344.3866);
      --input: oklch(0.9230 0.0701 326.1273);
      --muted: oklch(0.9429 0.0363 344.2604);
      --muted-foreground: oklch(0.5740 0.1732 352.0544);
      --radius: 0.5rem;
      --shadow: 0px 3px 0px 0px hsl(330 70% 30% / 0.18), 0px 1px 2px -1px hsl(330 70% 30% / 0.18);
      --font-sans: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: var(--font-sans);
      background: var(--background);
      overflow: hidden;
      height: 100vh;
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem;
      background: var(--card);
      border-bottom: 1px solid var(--border);
    }

    .header h1 {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--foreground);
    }

    .btn-save {
      background: var(--primary);
      color: var(--primary-foreground);
      border: none;
      padding: 0.5rem 1.5rem;
      border-radius: var(--radius);
      font-weight: 600;
      font-size: 0.875rem;
      cursor: pointer;
      box-shadow: var(--shadow);
    }

    .main-container {
      display: flex;
      flex-direction: column;
      height: calc(100vh - 60px);
    }

    .canvas-wrapper {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--muted);
      position: relative;
      overflow: hidden;
    }

    .upload-zone {
      text-align: center;
      padding: 2rem;
    }

    .upload-zone.hidden {
      display: none;
    }

    .upload-icon {
      font-size: 4rem;
      margin-bottom: 1rem;
    }

    .upload-text {
      font-size: 1rem;
      color: var(--muted-foreground);
      margin-bottom: 1rem;
    }

    .btn-upload {
      background: var(--primary);
      color: var(--primary-foreground);
      border: none;
      padding: 0.75rem 2rem;
      border-radius: var(--radius);
      font-size: 1rem;
      cursor: pointer;
      font-weight: 600;
      box-shadow: var(--shadow);
    }

    input[type="file"] {
      display: none;
    }

    .canvas-container {
      position: relative;
      width: 100%;
      max-width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      touch-action: none;
      cursor: grab;
    }

    .canvas-container:active {
      cursor: grabbing;
    }

    canvas {
      max-width: 100%;
      max-height: 100%;
      display: block;
      box-shadow: var(--shadow);
    }

    .controls {
      background: var(--card);
      padding: 1.5rem 1rem;
      border-top: 1px solid var(--border);
    }

    .zoom-control {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .control-label {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--foreground);
      margin-bottom: 0.5rem;
    }

    .zoom-icon {
      font-size: 1.25rem;
      color: var(--muted-foreground);
      min-width: 24px;
      text-align: center;
    }

    input[type="range"] {
      flex: 1;
      height: 6px;
      border-radius: 3px;
      background: var(--secondary);
      outline: none;
      -webkit-appearance: none;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: var(--primary);
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    input[type="range"]::-moz-range-thumb {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: var(--primary);
      cursor: pointer;
      border: none;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .helper-text {
      text-align: center;
      font-size: 0.75rem;
      color: var(--muted-foreground);
      margin-top: 0.5rem;
    }

    .toast {
      position: fixed;
      bottom: 2rem;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: var(--card);
      color: var(--card-foreground);
      padding: 1rem 1.5rem;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      opacity: 0;
      transition: all 0.3s;
      z-index: 1000;
      font-size: 0.875rem;
    }

    .toast.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>미디어 수정</h1>
    <button class="btn-save" id="saveBtn" style="display: none;">적용</button>
  </div>

  <div class="main-container">
    <div class="canvas-wrapper">
      <div id="uploadZone" class="upload-zone">
        <div class="upload-icon">📸</div>
        <div class="upload-text">프로필 이미지를 선택하세요</div>
        <button class="btn-upload" id="uploadBtn">이미지 선택</button>
        <input type="file" id="fileInput" accept="image/*">
      </div>

      <div id="canvasArea" style="display: none; width: 100%; height: 100%;">
        <div class="canvas-container" id="canvasContainer">
          <canvas id="mainCanvas"></canvas>
        </div>
      </div>
    </div>

    <div class="controls" id="controls" style="display: none;">
      <div class="control-label">확대/축소</div>
      <div class="zoom-control">
        <span class="zoom-icon">🔍</span>
        <input type="range" id="zoomSlider" min="20" max="300" value="100">
        <span class="zoom-icon">🔍</span>
      </div>
      
      <div class="control-label" style="margin-top: 1rem;">회전</div>
      <div class="zoom-control">
        <span class="zoom-icon">↶</span>
        <input type="range" id="rotateSlider" min="-180" max="180" value="0">
        <span class="zoom-icon">↷</span>
      </div>

      <div class="helper-text">드래그하여 위치 조정 • 슬라이더로 확대/축소/회전</div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    const state = {
      image: null,
      scale: 1,
      rotation: 0,
      offsetX: 0,
      offsetY: 0,
      isDragging: false,
      lastTouchDistance: 0,
      startX: 0,
      startY: 0
    };

    const uploadZone = document.getElementById('uploadZone');
    const uploadBtn = document.getElementById('uploadBtn');
    const fileInput = document.getElementById('fileInput');
    const canvasArea = document.getElementById('canvasArea');
    const canvasContainer = document.getElementById('canvasContainer');
    const canvas = document.getElementById('mainCanvas');
    const ctx = canvas.getContext('2d');
    const controls = document.getElementById('controls');
    const saveBtn = document.getElementById('saveBtn');
    const zoomSlider = document.getElementById('zoomSlider');
    const rotateSlider = document.getElementById('rotateSlider');

    const CANVAS_WIDTH = 1500;
    const CANVAS_HEIGHT = 600;
    const CIRCLE_SIZE = 350;
    const CIRCLE_X = CANVAS_WIDTH * 0.3;
    const CIRCLE_Y = CANVAS_HEIGHT * 0.5;

    const dpr = Math.min(window.devicePixelRatio || 1, 2);
    canvas.width = CANVAS_WIDTH * dpr;
    canvas.height = CANVAS_HEIGHT * dpr;
    ctx.scale(dpr, dpr);
    ctx.imageSmoothingEnabled = true;
    ctx.imageSmoothingQuality = 'high';

    uploadBtn.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', handleFileSelect);
    saveBtn.addEventListener('click', saveImage);

    zoomSlider.addEventListener('input', (e) => {
      state.scale = e.target.value / 100;
      render();
    });

    rotateSlider.addEventListener('input', (e) => {
      state.rotation = parseInt(e.target.value);
      render();
    });

    canvasContainer.addEventListener('mousedown', handleStart);
    canvasContainer.addEventListener('mousemove', handleMove);
    canvasContainer.addEventListener('mouseup', handleEnd);
    canvasContainer.addEventListener('mouseleave', handleEnd);
    
    canvasContainer.addEventListener('touchstart', handleTouchStart, { passive: false });
    canvasContainer.addEventListener('touchmove', handleTouchMove, { passive: false });
    canvasContainer.addEventListener('touchend', handleEnd);

    canvasContainer.addEventListener('wheel', (e) => {
      e.preventDefault();
      const delta = e.deltaY > 0 ? -5 : 5;
      const newValue = Math.max(20, Math.min(300, parseInt(zoomSlider.value) + delta));
      zoomSlider.value = newValue;
      state.scale = newValue / 100;
      render();
    }, { passive: false });

    function handleFileSelect(e) {
      if (e.target.files.length) {
        handleFile(e.target.files[0]);
      }
    }

    function handleFile(file) {
      if (!file.type.startsWith('image/')) {
        showToast('이미지 파일만 선택 가능합니다');
        return;
      }

      const reader = new FileReader();
      reader.onload = (e) => {
        const img = new Image();
        img.onload = () => {
          state.image = img;
          uploadZone.classList.add('hidden');
          canvasArea.style.display = 'block';
          controls.style.display = 'block';
          saveBtn.style.display = 'block';
          
          state.scale = 1.2;
          state.rotation = 0;
          state.offsetX = 0;
          state.offsetY = 0;
          
          zoomSlider.value = state.scale * 100;
          rotateSlider.value = 0;
          render();
          showToast('이미지 로드 완료!');
        };
        img.onerror = () => showToast('이미지 로드 실패');
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }

    function handleStart(e) {
      if (!state.image) return;
      e.preventDefault();
      
      state.isDragging = true;
      const rect = canvasContainer.getBoundingClientRect();
      state.startX = e.clientX - rect.left;
      state.startY = e.clientY - rect.top;
    }

    function handleMove(e) {
      if (!state.isDragging) return;
      e.preventDefault();
      
      const rect = canvasContainer.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      
      const dx = x - state.startX;
      const dy = y - state.startY;
      
      state.offsetX += dx;
      state.offsetY += dy;
      
      state.startX = x;
      state.startY = y;
      render();
    }

    function handleEnd() {
      state.isDragging = false;
    }

    function handleTouchStart(e) {
      if (!state.image) return;
      e.preventDefault();
      
      if (e.touches.length === 2) {
        const dx = e.touches[0].clientX - e.touches[1].clientX;
        const dy = e.touches[0].clientY - e.touches[1].clientY;
        state.lastTouchDistance = Math.sqrt(dx * dx + dy * dy);
      } else if (e.touches.length === 1) {
        state.isDragging = true;
        const rect = canvasContainer.getBoundingClientRect();
        state.startX = e.touches[0].clientX - rect.left;
        state.startY = e.touches[0].clientY - rect.top;
      }
    }

    function handleTouchMove(e) {
      if (!state.image) return;
      e.preventDefault();
      
      if (e.touches.length === 2 && state.lastTouchDistance > 0) {
        const dx = e.touches[0].clientX - e.touches[1].clientX;
        const dy = e.touches[0].clientY - e.touches[1].clientY;
        const distance = Math.sqrt(dx * dx + dy * dy);
        const delta = distance - state.lastTouchDistance;
        
        const newValue = Math.max(20, Math.min(300, parseInt(zoomSlider.value) + delta * 0.5));
        zoomSlider.value = newValue;
        state.scale = newValue / 100;
        
        state.lastTouchDistance = distance;
        render();
      } else if (e.touches.length === 1 && state.isDragging) {
        const rect = canvasContainer.getBoundingClientRect();
        const x = e.touches[0].clientX - rect.left;
        const y = e.touches[0].clientY - rect.top;
        
        const dx = x - state.startX;
        const dy = y - state.startY;
        
        state.offsetX += dx;
        state.offsetY += dy;
        
        state.startX = x;
        state.startY = y;
        render();
      }
    }

    function render() {
      if (!state.image) return;
      
      ctx.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
      
      ctx.save();
      ctx.translate(CANVAS_WIDTH / 2 + state.offsetX, CANVAS_HEIGHT / 2 + state.offsetY);
      ctx.rotate(state.rotation * Math.PI / 180);
      ctx.scale(state.scale, state.scale);
      
      const imgRatio = state.image.width / state.image.height;
      const canvasRatio = CANVAS_WIDTH / CANVAS_HEIGHT;
      let drawWidth, drawHeight;
      
      if (imgRatio > canvasRatio) {
        drawHeight = CANVAS_HEIGHT;
        drawWidth = drawHeight * imgRatio;
      } else {
        drawWidth = CANVAS_WIDTH;
        drawHeight = drawWidth / imgRatio;
      }
      
      ctx.drawImage(state.image, -drawWidth / 2, -drawHeight / 2, drawWidth, drawHeight);
      ctx.restore();
      
      ctx.save();
      ctx.fillStyle = 'rgba(0, 0, 0, 0.4)';
      ctx.fillRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
      ctx.globalCompositeOperation = 'destination-out';
      ctx.beginPath();
      ctx.arc(CIRCLE_X, CIRCLE_Y, CIRCLE_SIZE / 2, 0, Math.PI * 2);
      ctx.fill();
      ctx.restore();
      
      ctx.save();
      ctx.strokeStyle = '#ffffff';
      ctx.lineWidth = 5;
      ctx.beginPath();
      ctx.arc(CIRCLE_X, CIRCLE_Y, CIRCLE_SIZE / 2, 0, Math.PI * 2);
      ctx.stroke();
      ctx.restore();
    }

    function saveImage() {
      if (!state.image) {
        showToast('먼저 이미지를 업로드하세요');
        return;
      }
      
      // 원형 크기만큼의 작은 캔버스 생성
      const exportCanvas = document.createElement('canvas');
      const exportSize = CIRCLE_SIZE;
      exportCanvas.width = exportSize;
      exportCanvas.height = exportSize;
      const exportCtx = exportCanvas.getContext('2d');
      
      exportCtx.imageSmoothingEnabled = true;
      exportCtx.imageSmoothingQuality = 'high';
      
      // 투명 배경으로 시작 (fillRect 하지 않음)
      
      // 원형으로 클리핑
      exportCtx.save();
      exportCtx.beginPath();
      exportCtx.arc(exportSize / 2, exportSize / 2, exportSize / 2 - 3, 0, Math.PI * 2);
      exportCtx.clip();
      
      // 이미지 그리기
      exportCtx.save();
      
      // 원본 캔버스에서 원의 중심 좌표를 계산
      const offsetFromCenterX = CIRCLE_X - CANVAS_WIDTH / 2;
      const offsetFromCenterY = CIRCLE_Y - CANVAS_HEIGHT / 2;
      
      // 새 캔버스의 중심으로 이동하고 사용자 조정 적용
      exportCtx.translate(
        exportSize / 2 + state.offsetX - offsetFromCenterX,
        exportSize / 2 + state.offsetY - offsetFromCenterY
      );
      exportCtx.rotate(state.rotation * Math.PI / 180);
      exportCtx.scale(state.scale, state.scale);
      
      const imgRatio = state.image.width / state.image.height;
      const canvasRatio = CANVAS_WIDTH / CANVAS_HEIGHT;
      let drawWidth, drawHeight;
      
      if (imgRatio > canvasRatio) {
        drawHeight = CANVAS_HEIGHT;
        drawWidth = drawHeight * imgRatio;
      } else {
        drawWidth = CANVAS_WIDTH;
        drawHeight = drawWidth / imgRatio;
      }
      
      exportCtx.drawImage(state.image, -drawWidth / 2, -drawHeight / 2, drawWidth, drawHeight);
      exportCtx.restore();
      exportCtx.restore();
      
      // 흰색 테두리 그리기
      exportCtx.strokeStyle = '#ffffff';
      exportCtx.lineWidth = 7;
      exportCtx.beginPath();
      exportCtx.arc(exportSize / 2, exportSize / 2, exportSize / 2 - 3, 0, Math.PI * 2);
      exportCtx.stroke();
      
      // PNG로 저장 (투명 배경 유지)
      exportCanvas.toBlob(async (blob) => {
        const fileName = `notion-profile-${Date.now()}.png`;
        
        // 모바일에서 Web Share API 지원 확인
        if (navigator.share && navigator.canShare && navigator.canShare({ files: [new File([blob], fileName, { type: 'image/png' })] })) {
          try {
            const file = new File([blob], fileName, { type: 'image/png' });
            await navigator.share({
              files: [file],
              title: '노션 프로필 이미지',
              text: '생성된 프로필 이미지'
            });
            showToast('이미지 공유 완료! 🎉');
          } catch (err) {
            // 사용자가 공유 취소한 경우 등
            if (err.name !== 'AbortError') {
              console.error('Share failed:', err);
              fallbackDownload(blob, fileName);
            }
          }
        } else {
          // 데스크톱 또는 Web Share API 미지원 환경
          fallbackDownload(blob, fileName);
        }
      }, 'image/png');
    }
    
    function fallbackDownload(blob, fileName) {
      // iOS Safari 등에서도 작동하도록 개선된 다운로드 방식
      const url = URL.createObjectURL(blob);
      
      // 모바일 감지
      const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
      
      if (isMobile) {
        // 모바일: 새 탭에서 이미지 열기 (길게 눌러 저장 가능)
        const newWindow = window.open();
        if (newWindow) {
          newWindow.document.write(`
            <html>
              <head>
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>프로필 이미지</title>
                <style>
                  body {
                    margin: 0;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    min-height: 100vh;
                    background: #f5f5f5;
                    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
                  }
                  img {
                    max-width: 90%;
                    height: auto;
                    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                  }
                  .instruction {
                    margin-top: 20px;
                    padding: 15px;
                    background: white;
                    border-radius: 10px;
                    text-align: center;
                    color: #333;
                  }
                </style>
              </head>
              <body>
                <img src="${url}" alt="노션 프로필 이미지">
                <div class="instruction">
                  <p><strong>📱 이미지를 길게 눌러서 앨범에 저장하세요</strong></p>
                </div>
              </body>
            </html>
          `);
          showToast('이미지를 길게 눌러 저장하세요');
        }
      } else {
        // 데스크톱: 자동 다운로드
        const a = document.createElement('a');
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        showToast('이미지 저장 완료! 🎉');
      }
      
      setTimeout(() => URL.revokeObjectURL(url), 100);
    }

    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }
  </script>
</body>
</html>
